services:
  # ==============================
  # Core Datamate Services (always enabled)
  # ==============================

  datamate-backend:
    container_name: datamate-backend
    image: ${REGISTRY:-}datamate-backend
    restart: on-failure
    privileged: true
    environment:
      DB_PASSWORD: ${DB_PASSWORD:-password}
    volumes:
      - dataset_volume:/dataset
      - flow_volume:/flow
      - log_volume:/var/log/datamate
      - operator-upload-volume:/operators/upload
      - operator-runtime-volume:/operators/extract
    networks: [ datamate ]
    depends_on:
      - datamate-database

  datamate-backend-python:
    container_name: datamate-backend-python
    image: ${REGISTRY:-}datamate-backend-python
    restart: on-failure
    privileged: true
    environment:
      - log_level=DEBUG
      - pgsql_password=${DB_PASSWORD:-password}
    volumes:
      - dataset_volume:/dataset
      - flow_volume:/flow
      - log_volume:/var/log/datamate
    networks: [ datamate ]
    depends_on:
      - datamate-database

  datamate-gateway:
    container_name: datamate-gateway
    image: ${REGISTRY:-}datamate-gateway
    restart: on-failure
    privileged: true
    environment:
      - JWT_SECRET=default-insecure-key-change-in-production
    networks: [ datamate ]

  datamate-frontend:
    container_name: datamate-frontend
    image: ${REGISTRY:-}datamate-frontend
    restart: on-failure
    ports:
      - "30000:3000"
    volumes:
      - frontend_log_volume:/var/log/datamate/frontend
    networks: [ datamate ]
    depends_on:
      - datamate-backend
      - datamate-backend-python

  datamate-database:
    container_name: datamate-database
    image: ${REGISTRY:-}datamate-database
    restart: on-failure
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${DB_PASSWORD:-password}
    volumes:
      - postgresql_volume:/var/lib/postgresql/data
      - database_log_volume:/var/log/datamate/database
    ports:
      - "5432:5432"
    networks: [ datamate ]

  datamate-runtime:
    container_name: datamate-runtime
    image: ${REGISTRY:-}datamate-runtime
    restart: on-failure
    environment:
      RAY_DEDUP_LOGS: "0"
      RAY_TQDM_PATCH_PRINT: "0"
      PG_HOST: "datamate-database"
      PG_PORT: "5432"
      PG_USER: "postgres"
      PG_PASSWORD: ${DB_PASSWORD:-password}
      PG_DATABASE: "datamate"
    command:
      - python
      - /opt/runtime/datamate/operator_runtime.py
      - --port
      - "8081"
    volumes:
      - ray_log_volume:/tmp/ray
      - log_volume:/var/log/datamate
      - dataset_volume:/dataset
      - flow_volume:/flow
      - operator-runtime-volume:/opt/runtime/datamate/ops/user
      - operator-packages-volume:/usr/local/lib/ops/site-packages
    networks: [ datamate ]

  # =============================
  # Optional: Mineru NPU Engine (profile: mineru)
  # ==============================
  datamate-mineru:
    container_name: datamate-mineru
    image: datamate-mineru
    restart: on-failure
    environment:
      MINERU_MODEL_SOURCE: local
      MINERU_DEVICE_MODE: npu
      VLLM_WORKER_MULTIPROC_METHOD: spawn
    privileged: true
    entrypoint: mineru-openai-server
    command:
      --engine vllm
      --host 0.0.0.0
      --port 8000
    volumes:
      - dataset_volume:/dataset
      - mineru_log_volume:/var/log/datamate/mineru
      - /var/log/npu/:/usr/slog
      - /usr/local/dcmi:/usr/local/dcmi
      - /usr/local/bin/npu-smi:/usr/local/bin/npu-smi
      - /usr/local/Ascend/driver:/usr/local/Ascend/driver
    networks: [ datamate ]
    profiles: [ mineru ]
    devices:
      - /dev/davinci0
      - /dev/davinci_manager
      - /dev/devmm_svm
      - /dev/hisi_hdc

  # ==============================
  # Optional: Redis (profile: redis)
  # ==============================
  datamate-redis:
    container_name: datamate-redis
    image: redis:8.2.3
    restart: on-failure
    ports:
      - "6379:6379"
    networks: [ datamate ]
    profiles: [ redis ]

  # ==============================
  # Optional: Data Juicer (profile: data-juicer)
  # ==============================
  datamate-data-juicer:
    container_name: datamate-data-juicer
    image: datajuicer/data-juicer:v1.4.4
    restart: on-failure
    command:
      - uvicorn
      - service:app
      - --host
      - "0.0.0.0"
    volumes:
      - dataset_volume:/dataset
      - flow_volume:/flow
    networks: [ datamate ]
    profiles: [ data-juicer ]


  # ==============================
  # Optional: Deer Flow (profile: deer-flow)
  # ==============================
  deer-flow-backend:
    image: ${REGISTRY:-}deer-flow-backend
    container_name: deer-flow-backend
    env_file:
      - .env
    volumes:
      - ./conf.yaml:/app/conf.yaml:ro
      - deer-flow-log-volume:/var/log/deer-flow
    restart: on-failure
    networks:
      - datamate
    profiles:
      - deer-flow

  deer-flow-frontend:
    image: ${REGISTRY:-}deer-flow-frontend
    container_name: deer-flow-frontend
    env_file:
      - .env
    depends_on:
      - deer-flow-backend
    restart: on-failure
    networks:
      - datamate
    profiles:
      - deer-flow

  # ==============================
  # Optional: Label Studio (profile: label-studio)
  # ==============================
  label-studio:
    container_name: label-studio
    stdin_open: true
    tty: true
    image: heartexlabs/label-studio:latest
    privileged: true
    restart: on-failure
    user: root
    expose:
      - "8000"
    ports:
      - "30001:8000"
    depends_on:
      - datamate-database
    environment:
      - DJANGO_DB=default
      - POSTGRE_NAME=labelstudio
      - POSTGRE_USER=postgres
      - POSTGRE_PASSWORD=${DB_PASSWORD:-password}
      - POSTGRE_PORT=5432
      - POSTGRE_HOST=datamate-database
      - LABEL_STUDIO_HOST=${LABEL_STUDIO_HOST:-}
      - LOCAL_FILES_SERVING_ENABLED=true
      - LOCAL_FILES_DOCUMENT_ROOT=/label-studio/local
      - USE_USERNAME_FOR_LOGIN=true
      - LABEL_STUDIO_USERNAME=admin@demo.com
      - LABEL_STUDIO_PASSWORD=demoadmin
      - LABEL_STUDIO_ENABLE_LEGACY_API_TOKEN=true
      - LABEL_STUDIO_USER_TOKEN=abc123abc123
      - LOG_LEVEL=DEBUG
    volumes:
      - label-studio-data:/label-studio/data:rw
      - dataset_volume:/label-studio/local:rw
    networks:
      - datamate
    command: label-studio-uwsgi
    profiles: [ label-studio ]

  # ==============================
  # Optional: Milvus (profile: milvus)
  # ==============================
  etcd:
    container_name: milvus-etcd
    image: quay.io/coreos/etcd:v3.5.18
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - etcd-volume:/etcd
    command: etcd -advertise-client-urls=http://etcd:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    restart: always
    networks:
      - datamate
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 20s
      retries: 3
    profiles:
      - milvus

  minio:
    container_name: milvus-minio
    image: minio/minio:RELEASE.2024-12-18T13-15-44Z
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    ports:
      - "9001:9001"
      - "9000:9000"
    volumes:
      - minio-volume:/data
    command: minio server /data --console-address ":9001"
    networks:
      - datamate
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    profiles:
      - milvus

  milvus:
    container_name: milvus-standalone
    restart: on-failure
    image: milvusdb/milvus:v2.6.5
    command: ["milvus", "run", "standalone"]
    security_opt:
    - seccomp:unconfined
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MQ_TYPE: woodpecker
    volumes:
      - milvus-volume:/var/lib/milvus
    networks:
      - datamate
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      start_period: 90s
      timeout: 20s
      retries: 3
    ports:
      - "19530:19530"
      - "9091:9091"
    depends_on:
      - "etcd"
      - "minio"
    profiles:
      - milvus

# ==============================
# Volumes
# ==============================
volumes:
  dataset_volume:
    name: datamate-dataset-volume
  flow_volume:
    name: datamate-flow-volume
  log_volume:
    name: datamate-log-volume
  postgresql_volume:
    name: datamate-postgresql-volume
  ray_log_volume:
    name: datamate-ray-log-volume
  frontend_log_volume:
    name: datamate-frontend-log-volume
  database_log_volume:
    name: datamate-database-log-volume
  operator-upload-volume:
    name: datamate-operator-upload-volume
  operator-runtime-volume:
    name: datamate-operator-runtime-volume
  operator-packages-volume:
    name: datamate-operator-packages-volume
  mineru_log_volume:
    name: datamate-mineru_log_volume

  # Deer Flow
  deer-flow-log-volume:
    name: deer-flow-log-volume

  # Label Studio
  label-studio-data:
    name: label-studio-data-volume
  label-studio-db:
    name: label-studio-db-volume

  # Milvus
  etcd-volume:
    name: milvus-etcd-volume
  minio-volume:
    name: milvus-minio-volume
  milvus-volume:
    name: milvus-milvus-volume


# ==============================
# Networks
# ==============================
networks:
  datamate:
    driver: bridge
    name: datamate-network
